# --- Redirect HTTP to HTTPS ---
server {
  listen 80;
  listen [::]:80;
  server_name shelva.app www.shelva.app;
  return 301 https://shelva.app$request_uri;
}

# --- Main HTTPS site ---
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name shelva.app www.shelva.app;

  # TLS (replace with your certs)
  ssl_certificate     /etc/letsencrypt/live/shelva.app/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/shelva.app/privkey.pem;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  root  /var/www/shelva-site;
  index index.html;

  access_log /var/log/nginx/shelva.access.log;
  error_log  /var/log/nginx/shelva.error.log;

  # Compression
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_types
    text/plain text/css text/javascript application/javascript application/json
    application/xml application/rss+xml image/svg+xml
    font/ttf font/otf application/font-woff application/font-woff2;

  # --- Security headers ---
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  # IMPORTANT: allow your actual asset hosts in CSP (Webflow/CDNs/Google Fonts)
  add_header Content-Security-Policy "
    default-src 'self';
    img-src 'self' data: https://cdn.prod.website-files.com https://cdn.prod.website-files.com/* https://cdn.prod.website-files.com/img https://images.unsplash.com https://*.googleusercontent.com https://*.gstatic.com https://*.googleapis.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.prod.website-files.com;
    font-src  'self' data: https://fonts.gstatic.com https://cdn.prod.website-files.com;
    script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://d3e54v103j8qbb.cloudfront.net https://cdn.prod.website-files.com;
    connect-src 'self';
    frame-ancestors 'self';
    base-uri 'self';
    form-action 'self' mailto:;
    upgrade-insecure-requests
  " always;

  # --- Pretty URLs + SPA-ish fallback for root index ---
  location / {
    try_files $uri $uri.html $uri/ /index.html;
  }

  # Static assets: long cache
  location ~* \.(?:css|js|mjs|json|png|jpg|jpeg|gif|webp|svg|ico|woff|woff2|ttf|otf)$ {
    access_log off;
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # HTML: short cache
  location ~* \.html$ {
    add_header Cache-Control "public, max-age=60";
    try_files $uri =404;
  }

  # Robots + sitemap
  location = /robots.txt   { default_type text/plain;        add_header Cache-Control "public, max-age=3600"; try_files $uri =404; }
  location = /sitemap.xml  { default_type application/xml;   add_header Cache-Control "public, max-age=3600"; try_files $uri =404; }

  # Custom 404
  error_page 404 /404.html;
  location = /404.html { internal; }
}
